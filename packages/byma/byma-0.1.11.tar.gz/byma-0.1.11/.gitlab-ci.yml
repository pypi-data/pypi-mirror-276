image: python:latest

stages:
  - Packages
  - Build
  - Publish
  - Pages deployment

install-framework:
  stage: Packages
  script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install twine
    - pip install .
  rules:
    - if: '$CI_COMMIT_TAG != "docs"'

publish-testpypi:
  stage: Publish
  script: 
    - pip install build twine
    - python -m build
    - python -m twine upload --repository testpypi --username "${TEST_PYPI_USERNAME}" --password "${TEST_PYPI_PASSWORD}" dist/*
  rules:
    - if: '$CI_COMMIT_TAG =~ "/^test\d+\v\d+\.\d+\.\d+$/"'


publish:
  stage: Publish
  script:
    - pip install build twine
    - python -m build
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token python -m twine upload --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*
    - python -m twine upload --repository pypi --username "${PYPI_USERNAME}" --password "${PYPI_PASSWORD}" --verbose dist/*
  only:
    - /^v\d+\.\d+\.\d+$/  # This will match tags with the format vX.Y.Z

# Push the book's HTML to gitlab-pages
pages:
  stage: Pages deployment
  image: python:3.9-slim
  script:
    - apt-get update && apt-get install make --no-install-recommends -y
    - python -m pip install -r docs/requirements.txt
    - pip install -r requirements.txt
    - pip install byma
    - sphinx-build -M html docs/source/ docs/build/  
    - mv docs/build/html/ public/
  artifacts:
    paths:
      - public
  rules:
    - if: ('$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/ || $CI_COMMIT_TAG == "docs"') && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH